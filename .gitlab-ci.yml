variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: "tcp://docker:2375"
    MYSQL_ROOT_PASSWORD: app
    WEB_DOCUMENT_ROOT: $CI_PROJECT_DIR/development/public
    REPOSITORY_HOST: "gitlab.shopware.com:5005"
    PLATFORM_BRANCH: "6.1"

stages:
    - Build
    - Static analysis
    - Unit

cache:
    key: "Eternal static key"
    paths:
        - .composer

Build-Analysis-Container:
    stage: Build
    when: manual
    image: docker
    services:
        -   name: docker:18.09.7-dind
            alias: docker
    script:
        - export IMAGE_NAME="${REPOSITORY_HOST}/shopware/shopware-cloud/connect/php-static-analysis"
        - apk add git bash
        - docker login "${REPOSITORY_HOST}" -u $REGISTRY_USERNAME --password-stdin < $REGISTRY_PASSWORD_FILE
        - docker build dev-ops/tools -t "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
        - docker tag "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}" "${IMAGE_NAME}:latest"
        - docker push "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
        - docker push "${IMAGE_NAME}:latest"

EasyCodingStandard:
    stage: Static analysis
    image: gitlab.shopware.com:5005/shopware/shopware-cloud/connect/php-static-analysis:latest
    script:
        - composer install --ignore-platform-reqs --no-interaction --optimize-autoloader --no-suggest --no-scripts --no-progress
        - ecs check .


Psalm:
    stage: Static analysis
    image: gitlab.shopware.com:5005/shopware/shopware-cloud/connect/php-static-analysis:latest
    script:
        - composer install --ignore-platform-reqs --no-interaction --optimize-autoloader --no-suggest --no-scripts --no-progress
        - psalm --output-format=compact


Phpstan:
    stage: Static analysis
    image: gitlab.shopware.com:5005/shopware/shopware-cloud/connect/php-static-analysis:latest
    script:
        - composer install --ignore-platform-reqs --no-interaction --optimize-autoloader --no-suggest --no-scripts --no-progress
        - phpstan analyze --configuration phpstan.neon src

PhpInsights:
    stage: Static analysis
    image: gitlab.shopware.com:5005/shopware/shopware-cloud/connect/php-static-analysis:latest
    script:
        - composer install --ignore-platform-reqs --no-interaction --optimize-autoloader --no-suggest --no-scripts --no-progress
        - phpinsights --no-interaction

Eslint Administration:
    stage: Static analysis
    image: shopware/development:latest
    before_script:
        - zip -rq plugin.zip .
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/development.git --branch $PLATFORM_BRANCH
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/platform.git development/platform --branch $PLATFORM_BRANCH
        - unzip -q plugin.zip -d development/custom/plugins/SaasConnect
        - cd development
        - cp -v dev-ops/gitlab/.psh.yaml.override .
        - /entrypoint supervisord > /dev/null 2>&1 &
    script:
        - cd custom/plugins/SaasConnect/src/Resources/app/administration
        - npm install
        - npm run eslint-junit > eslint-administration.junit.xml
    artifacts:
        reports:
            junit: development/custom/plugins/SaasConnect/src/Resources/app/administration/eslint-administration.junit.xml

Unit:
    stage: Unit
    image: shopware/development:latest
    services:
        -   name: mysql:5.7
            alias: mysql
        -   name: elastic/elasticsearch:7.1.1
            alias: elasticsearch
            command: [ "bin/elasticsearch", "-Expack.security.enabled=false", "-Ediscovery.type=single-node" ]
    before_script:
        - zip -rq plugin.zip .
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/development.git --branch $PLATFORM_BRANCH
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/platform.git development/platform --branch $PLATFORM_BRANCH
        - unzip -q plugin.zip -d development/custom/plugins/SaasConnect
        - cd development
        - cp -v dev-ops/gitlab/.psh.yaml.override .
        - /entrypoint supervisord > /dev/null 2>&1 &
    script:
        - ./psh.phar init
        - php bin/console plugin:install --activate SaasConnect
        - composer dump-autoload -d custom/plugins/SaasConnect
        - ./psh.phar init-test-databases
        - php -d pcov.enabled=1 -d pcov.directory=$CI_PROJECT_DIR
            vendor/bin/phpunit
            --configuration custom/plugins/SaasConnect/phpunit.xml.dist
            --log-junit build/artifacts/phpunit.junit.xml
            --colors=never
            --coverage-clover build/artifacts/phpunit.clover.xml
            --coverage-html build/artifacts/phpunit-coverage-html
            --coverage-text

    coverage: '/^\s*Lines:\s*(\d+(?:\.\d+)?%)/'
    artifacts:
        paths:
            - development/build/artifacts/phpunit.clover.xml
        reports:
            junit: development/build/artifacts/phpunit.junit.xml

Jest (Administration):
    stage: Unit
    image: shopware/development:latest
    services:
        -   name: mysql:5.7
            alias: mysql
        -   name: elastic/elasticsearch:7.1.1
            alias: elasticsearch
            command: [ "bin/elasticsearch", "-Expack.security.enabled=false", "-Ediscovery.type=single-node" ]
    before_script:
        - zip -rq plugin.zip .
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/development.git --branch $PLATFORM_BRANCH
        - git clone http://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.shopware.com/shopware/6/product/platform.git development/platform --branch $PLATFORM_BRANCH
        - unzip -q plugin.zip -d development/custom/plugins/SaasConnect
        - cd development
        - cp -v dev-ops/gitlab/.psh.yaml.override .
        - /entrypoint supervisord > /dev/null 2>&1 &
    script:
        - composer install
        - ./psh.phar administration:install-dependencies
        - npm --prefix custom/plugins/SaasConnect/src/Resources/app/administration/ install
        - PROJECT_ROOT=${CI_PROJECT_DIR}/development npm --prefix custom/plugins/SaasConnect/src/Resources/app/administration/ run unit

    coverage: '/^\s?All files[^|]*\|[^|]*\s+([\d\.]+)/'
    artifacts:
        paths:
            - development/build/artifacts/clover.xml
        reports:
            junit: development/build/artifacts/administration.junit.xml
